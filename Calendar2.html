<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カレンダーウェブアプリ</title>
    <style>
        @layer base {
            :root {
                --color-neutral-100: #f5f5f5;
                --color-neutral-200: #e5e5e5;
                --color-neutral-300: #d4d4d4;
                --color-neutral-400: #a3a3a3;
                --color-neutral-500: #737373;
                --color-neutral-600: #525252;
                --color-neutral-700: #404040;
                --color-neutral-800: #262626;
                --color-neutral-900: #171717;
                --color-blue-500: #3b82f6;
                --color-red-500: #ef4444;
                --color-yellow-500: #eab308;
                --color-green-500: #22c55e;
                --color-green-200: #dcfce7;
                --color-red-200: #fecaca;
                --color-blue-200: #bfdbfe;
            }
        }
        
        @layer components {
            .flex { display: flex; }
            .items-center { align-items: center; }
            .justify-between { justify-content: space-between; }
            .justify-end { justify-content: flex-end; }
            .justify-center { justify-content: center; }
            .space-x-4 > :not([hidden]) ~ :not([hidden]) { margin-left: 1rem; }
            .space-x-2 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.5rem; }
            .mb-6 { margin-bottom: 1.5rem; }
            .mb-4 { margin-bottom: 1rem; }
            .mt-auto { margin-top: auto; }
            .px-4 { padding-left: 1rem; padding-right: 1rem; }
            .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
            .p-2 { padding: 0.5rem; }
            .p-6 { padding: 1.5rem; }
            .p-8 { padding: 2rem; }
            .rounded-full { border-radius: 9999px; }
            .rounded-xl { border-radius: 0.75rem; }
            .rounded-md { border-radius: 0.375rem; }
            .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
            .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
            .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
            .text-2xl { font-size: 1.5rem; line-height: 2rem; }
            .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
            .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
            .text-xs { font-size: 0.75rem; line-height: 1rem; }
            .font-bold { font-weight: 700; }
            .font-semibold { font-weight: 600; }
            .text-gray-800 { color: #1f2937; }
            .text-gray-700 { color: #374151; }
            .text-gray-600 { color: #4b5563; }
            .text-gray-500 { color: #6b7280; }
            .text-white { color: #ffffff; }
            .text-blue-600 { color: #2563eb; }
            .text-blue-700 { color: #1d4ed8; }
            .text-red-600 { color: #dc2626; }
            .text-red-700 { color: #b91c1c; }
            .hover\:bg-gray-200:hover { background-color: #e5e7eb; }
            .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
            .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
            .hover\:bg-red-700:hover { background-color: #b91c1c; }
            .transition-colors { transition-property: background-color, border-color, color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
            .bg-white { background-color: #ffffff; }
            .bg-gray-100 { background-color: #f3f4f6; }
            .bg-gray-200 { background-color: #e5e7eb; }
            .bg-blue-600 { background-color: #2563eb; }
            .bg-red-600 { background-color: #dc2626; }
            .bg-green-200 { background-color: var(--color-green-200); }
            .bg-red-200 { background-color: var(--color-red-200); }
            .bg-blue-200 { background-color: var(--color-blue-200); }
            .border { border-width: 1px; }
            .border-gray-300 { border-color: #d1d5db; }
            .border-gray-200 { border-color: #e5e7eb; }
            .w-full { width: 100%; }
            .max-w-4xl { max-width: 56rem; }
            .mx-auto { margin-left: auto; margin-right: auto; }
            .block { display: block; }
            .relative { position: relative; }
            .absolute { position: absolute; }
            .top-2 { top: 0.5rem; }
            .left-2 { left: 0.5rem; }
            .bottom-2 { bottom: 0.5rem; }
            .right-2 { right: 0.5rem; }
            .z-10 { z-index: 10; }
            .h-4 { height: 1rem; }
            .w-4 { width: 1rem; }
            .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .flex-col { flex-direction: column; }
            .self-end { align-self: flex-end; }
            .border-b { border-bottom-width: 1px; }
            .border-r { border-right-width: 1px; }
            .day-cell {
                min-height: 120px;
                background-color: #ffffff;
                position: relative;
                cursor: pointer;
                transition: transform 0.2s;
                display: flex;
                flex-direction: column;
                padding: 8px;
            }
            .day-cell:hover {
                transform: scale(1.02);
                z-index: 10;
            }
            .day-header {
                background-color: #e5e7eb;
                font-weight: 600;
                padding: 8px 0;
                text-align: center;
            }
            .weekday-cell {
                color: #4b5563;
            }
            .saturday {
                color: var(--color-blue-500);
            }
            .sunday {
                color: var(--color-red-500);
            }
            .holiday {
                background-color: var(--color-red-200);
            }
            .working-day {
                background-color: var(--color-green-200);
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 100;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                justify-content: center;
                align-items: center;
            }
            .modal-content {
                background-color: #ffffff;
                padding: 24px;
                border-radius: 0.75rem;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .memo-mark {
                position: absolute;
                bottom: 8px;
                right: 8px;
                color: var(--color-blue-500);
                font-size: 1rem;
                font-weight: bold;
            }
            .day-number {
                font-size: 1.125rem;
                font-weight: 600;
            }
            .memo-text {
                position: absolute;
                bottom: 8px;
                left: 8px;
                right: 8px;
                text-align: left;
                font-size: 0.75rem;
                color: #6b7280;
            }
            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
                background-color: #e5e7eb;
                border-radius: 0.5rem;
                overflow: hidden;
            }
            .day-cell {
                min-height: 120px;
                background-color: #ffffff;
                position: relative;
                cursor: pointer;
                transition: transform 0.2s;
                display: flex;
                flex-direction: column;
                padding: 8px;
                box-sizing: border-box;
            }
            .day-cell:hover {
                transform: scale(1.02);
                z-index: 10;
            }
        }
    </style>
</head>
<body class="p-8">
    <!-- メインコンテナ -->
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">
        
        <!-- ヘッダー -->
        <div class="flex items-center justify-between mb-6">
            <h1 id="month-display" class="text-3xl font-bold text-gray-800">2025年9月</h1>
            <div class="flex items-center space-x-4">
                <!-- 矢印を正しく中央に配置するために flex クラスを追加 -->
                <button onclick="changeMonth(-1)" class="flex items-center justify-center p-2 rounded-full hover:bg-gray-200 transition-colors duration-200">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <!-- 矢印を正しく中央に配置するために flex クラスを追加 -->
                <button onclick="changeMonth(1)" class="flex items-center justify-center p-2 rounded-full hover:bg-gray-200 transition-colors duration-200">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </div>

        <!-- 凡例とサマリー -->
        <div class="flex justify-end items-center mb-4 text-sm space-x-4">
            <div class="flex items-center space-x-2">
                <span class="w-4 h-4 rounded-full bg-green-200"></span>
                <span>稼働日</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="w-4 h-4 rounded-full bg-red-200"></span>
                <span>休日</span>
            </div>
            <div class="flex items-center space-x-2">
                <span id="working-days-summary">稼働日: 0日</span>
                <span id="holiday-days-summary">休日: 0日</span>
            </div>
        </div>
        
        <!-- カレンダーグリッド -->
        <div class="calendar-grid shadow-md">
            <div class="day-header weekday-cell">月</div>
            <div class="day-header weekday-cell">火</div>
            <div class="day-header weekday-cell">水</div>
            <div class="day-header weekday-cell">木</div>
            <div class="day-header weekday-cell">金</div>
            <div class="day-header saturday">土</div>
            <div class="day-header sunday">日</div>

            <!-- 日付セルはJavaScriptで動的に生成されます -->
        </div>
    </div>
    
    <!-- デイリーカレンダー詳細モーダル -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-date" class="text-2xl font-bold mb-4 text-gray-800"></h2>
            <div class="mb-4">
                <label for="status-select" class="block text-sm font-medium text-gray-700">状態</label>
                <select id="status-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="working">稼働日</option>
                    <option value="holiday">休日</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="memo-textarea" class="block text-sm font-medium text-gray-700">摘要 (メモ)</label>
                <textarea id="memo-textarea" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-700 rounded-md border border-gray-300 hover:bg-gray-100 transition-colors duration-200">キャンセル</button>
                <button id="save-button" onclick="saveDailyCalendar()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200">保存</button>
                <button id="delete-button" onclick="deleteDailyCalendar()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200" style="display: none;">削除</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ブラウザのセキュリティ制約を回避するため、CDNからFirebase SDKを直接インポートします
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebaseとアプリのグローバル変数
        let app, db, auth;
        let userId;
        let currentMonth = new Date();
        let currentDayData = null; // 現在選択中の日付のデータを保持
        let calendarData = {}; // Firestoreから取得したデータをキャッシュするオブジェクト

        // グローバル変数からアプリのID、Firebase設定、認証トークンを取得
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI要素への参照
        const monthDisplay = document.getElementById('month-display');
        const calendarGrid = document.querySelector('.calendar-grid');
        const modal = document.getElementById('modal');
        const modalDate = document.getElementById('modal-date');
        const statusSelect = document.getElementById('status-select');
        const memoTextarea = document.getElementById('memo-textarea');
        const deleteButton = document.getElementById('delete-button');
        const workingDaysSummary = document.getElementById('working-days-summary');
        const holidayDaysSummary = document.getElementById('holiday-days-summary');

        /**
         * Firebaseを初期化し、ユーザー認証を行う
         */
        async function initializeFirebase() {
            try {
                // Firebaseを初期化
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 提供されたトークンでサインイン、トークンがなければ匿名でサインイン
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("カスタムトークンでサインインしました。");
                } else {
                    await signInAnonymously(auth);
                    console.log("匿名でサインインしました。");
                }

                // 認証状態の変更を監視
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("ユーザーがUID:", userId, "でサインインしました。");
                        loadCalendarData(); // 認証後にデータをロード
                    } else {
                        console.log("ユーザーがサインアウトしました。");
                        userId = null;
                    }
                });
            } catch (error) {
                console.error("Firebaseの初期化に失敗しました:", error);
            }
        }

        /**
         * Firestoreからカレンダーデータをロードする
         * onSnapshotでリアルタイムな変更を監視する
         */
        function loadCalendarData() {
            if (!userId) {
                console.warn("ユーザーIDが利用できません。データをロードできません。");
                return;
            }

            const userCalendarPath = `artifacts/${appId}/users/${userId}/calendar-entries`;
            const q = collection(db, userCalendarPath);

            onSnapshot(q, (querySnapshot) => {
                const tempCalendarData = {};
                querySnapshot.forEach((doc) => {
                    tempCalendarData[doc.id] = doc.data();
                });
                calendarData = tempCalendarData;
                renderCalendar();
                console.log("カレンダーデータが正常にロードされました。");
            }, (error) => {
                console.error("カレンダーデータのロード中にエラーが発生しました:", error);
            });
        }

        /**
         * カレンダーUIをレンダリングする
         */
        function renderCalendar() {
            // 既存のセルをクリア
            calendarGrid.querySelectorAll('.day-cell').forEach(cell => cell.remove());
            
            // 月表示を更新
            monthDisplay.textContent = new Intl.DateTimeFormat('ja-JP', { year: 'numeric', month: 'long' }).format(currentMonth);

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            
            const firstDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; // 月曜日を週の始まりに
            const daysInMonth = lastDayOfMonth.getDate();

            // 月の始まりの空白セルを追加
            for (let i = 0; i < firstDayOfWeek; i++) {
                const blankCell = document.createElement('div');
                blankCell.classList.add('day-cell');
                blankCell.style.cursor = 'default';
                blankCell.style.backgroundColor = 'var(--color-neutral-100)';
                calendarGrid.appendChild(blankCell);
            }

            let workingDays = 0;
            let holidayDays = 0;

            // 日付セルを追加
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('day-cell');
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.setAttribute('data-date', dateKey);

                const dayOfWeek = (new Date(year, month, day).getDay() + 6) % 7;
                const isWeekend = dayOfWeek >= 5; // 土曜日または日曜日

                const entry = calendarData[dateKey];
                let status = isWeekend ? 'holiday' : 'working';
                if (entry && entry.status) {
                    status = entry.status;
                }

                if (status === 'working') {
                    dayCell.classList.add('working-day');
                    workingDays++;
                } else {
                    dayCell.classList.add('holiday');
                    holidayDays++;
                }
                
                dayCell.innerHTML = `
                    <span class="day-number">${day}</span>
                    <span class="memo-text mt-auto truncate">${entry ? entry.memo : ''}</span>
                    ${entry && entry.memo ? '<span class="memo-mark">*</span>' : ''}
                `;

                dayCell.addEventListener('click', () => {
                    openModal(dayCell.getAttribute('data-date'));
                });

                calendarGrid.appendChild(dayCell);
            }

            // 凡例のサマリーを更新
            workingDaysSummary.textContent = `稼働日: ${workingDays}日`;
            holidayDaysSummary.textContent = `休日: ${holidayDays}日`;
        }

        /**
         * 月を変更する
         */
        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        /**
         * 詳細モーダルを開く
         */
        function openModal(date) {
            modalDate.textContent = new Intl.DateTimeFormat('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(date));
            
            currentDayData = { date };
            const entry = calendarData[date];
            
            if (entry) {
                statusSelect.value = entry.status;
                memoTextarea.value = entry.memo || '';
                deleteButton.style.display = 'inline-block';
            } else {
                statusSelect.value = 'working';
                memoTextarea.value = '';
                deleteButton.style.display = 'none';
            }

            modal.style.display = 'flex';
        }

        /**
         * 詳細モーダルを閉じる
         */
        function closeModal() {
            modal.style.display = 'none';
        }

        /**
         * 日付の情報をFirestoreに保存する
         */
        async function saveDailyCalendar() {
            if (!userId) {
                console.error("ユーザーが認証されていません。データを保存できません。");
                return;
            }

            const date = currentDayData.date;
            const status = statusSelect.value;
            const memo = memoTextarea.value;
            const dataToSave = { status, memo };
            
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/calendar-entries`, date);
                await setDoc(docRef, dataToSave, { merge: true });
                console.log("ドキュメントが日付:", date, "で正常に保存されました。");
            } catch (error) {
                console.error("ドキュメントの保存中にエラーが発生しました:", error);
            }
            closeModal();
        }

        /**
         * 日付の情報をFirestoreから削除する
         */
        async function deleteDailyCalendar() {
            if (!userId) {
                console.error("ユーザーが認証されていません。データを削除できません。");
                return;
            }

            const date = currentDayData.date;

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/calendar-entries`, date);
                await deleteDoc(docRef);
                console.log("ドキュメントが日付:", date, "で正常に削除されました。");
            } catch (error) {
                console.error("ドキュメントの削除中にエラーが発生しました:", error);
            }
            closeModal();
        }

        // 初期設定
        window.onload = initializeFirebase;

        // ボタンから呼び出せるようにグローバルスコープに公開
        window.changeMonth = changeMonth;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.saveDailyCalendar = saveDailyCalendar;
        window.deleteDailyCalendar = deleteDailyCalendar;
    </script>
</body>
</html>
